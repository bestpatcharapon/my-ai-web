<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Best Chat Bot</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
      /* --- CSS Style (Dark Mode) --- */
      body {
        font-family: "Sarabun", sans-serif;
        background-color: #202123;
        color: #ececf1;
        margin: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      header {
        background-color: #343541;
        padding: 15px;
        text-align: center;
        border-bottom: 1px solid #4d4d4f;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }
      h1 {
        margin: 0;
        font-size: 1.4rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      /* ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏°‡∏Ü */
      h1 i {
        color: #00ff88;
      }

      .status {
        font-size: 0.85rem;
        color: #00ff88;
        margin-top: 5px;
        opacity: 0.8;
      }

      #chat-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        scroll-behavior: smooth;
      }

      .message {
        display: flex;
        gap: 15px;
        max-width: 800px;
        margin: 0 auto;
        width: 100%;
        padding: 0 10px;
      }
      .message.user {
        flex-direction: row-reverse;
      }

      .avatar {
        width: 36px;
        height: 36px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        flex-shrink: 0;
      }
      .bot-avatar {
        background-color: #10a37f;
        color: white;
      }
      .user-avatar {
        background-color: #5436da;
        color: white;
      }

      .content {
        padding: 10px 15px;
        border-radius: 8px;
        background-color: #444654;
        line-height: 1.6;
        max-width: 80%;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        overflow-wrap: break-word;
      }
      .user .content {
        background-color: #343541;
        border: 1px solid #555;
      }

      pre {
        background: #000 !important;
        padding: 10px;
        border-radius: 5px;
        overflow-x: auto;
        margin: 10px 0;
      }
      code {
        font-family: monospace;
        font-size: 0.9em;
      }

      /* ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á */
      #preview-container {
        max-width: 800px;
        margin: 0 auto 10px;
        padding: 0 20px;
        display: none;
        position: relative;
        width: fit-content;
      }
      #preview-img {
        max-height: 120px;
        border-radius: 8px;
        border: 2px solid #10a37f;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }
      #remove-img {
        position: absolute;
        top: -10px;
        right: 10px;
        background: #ff4444;
        color: white;
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        cursor: pointer;
        font-size: 18px;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        transition: background 0.2s;
      }
      #remove-img:hover {
        background: #ff0000;
      }

      /* ‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó */
      .chat-img {
        max-width: 100%;
        max-height: 300px;
        border-radius: 8px;
        margin-bottom: 10px;
        display: block;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      #input-area {
        background-color: #343541;
        padding: 20px;
        border-top: 1px solid #4d4d4f;
      }
      .input-wrapper {
        max-width: 800px;
        margin: 0 auto;
        position: relative;
        display: flex;
        gap: 8px;
        align-items: flex-end;
      }

      textarea {
        flex: 1;
        padding: 15px 15px 15px 15px;
        border-radius: 12px;
        border: 1px solid #565869;
        background-color: #40414f;
        color: white;
        font-family: inherit;
        resize: none;
        height: 24px;
        max-height: 200px;
        outline: none;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      textarea:focus {
        border-color: #10a37f;
        background-color: #2f303d;
      }

      /* ‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô */
      .icon-btn {
        background: transparent;
        border: none;
        color: #ccc;
        cursor: pointer;
        padding: 8px 10px;
        transition: color 0.2s;
        font-size: 18px;
      }
      .icon-btn:hover {
        color: #10a37f;
      }
      .icon-btn:disabled {
        color: #555;
        cursor: not-allowed;
      }

      .loading-dots:after {
        content: " .";
        animation: dots 1s steps(5, end) infinite;
      }
      @keyframes dots {
        0%,
        20% {
          color: rgba(0, 0, 0, 0);
          text-shadow: 0.25em 0 0 rgba(0, 0, 0, 0), 0.5em 0 0 rgba(0, 0, 0, 0);
        }
        40% {
          color: white;
          text-shadow: 0.25em 0 0 rgba(0, 0, 0, 0), 0.5em 0 0 rgba(0, 0, 0, 0);
        }
        60% {
          text-shadow: 0.25em 0 0 white, 0.5em 0 0 rgba(0, 0, 0, 0);
        }
        80%,
        100% {
          text-shadow: 0.25em 0 0 white, 0.5em 0 0 white;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1><i class="fa-solid fa-cloud"></i> Best Chat Bot</h1>
      <div class="status">‚óè Online</div>
    </header>

    <div id="chat-container">
      <div class="message bot">
        <div class="avatar bot-avatar">AI</div>
        <div class="content">
          ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ú‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ñ‡∏≤‡∏°‡∏≠‡∏∞‡πÑ‡∏£‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
          ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏ú‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö! üì∏
        </div>
      </div>
    </div>

    <!-- ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á -->
    <div id="preview-container">
      <img id="preview-img" src="" alt="Preview" />
      <button id="remove-img" onclick="clearImage()">√ó</button>
    </div>

    <div id="input-area">
      <div class="input-wrapper">
        <!-- Input File ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ -->
        <input
          type="file"
          id="imageInput"
          accept="image/*"
          style="display: none"
          onchange="handleImageSelect()"
        />

        <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ -->
        <button
          class="icon-btn"
          onclick="document.getElementById('imageInput').click()"
          title="‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û"
        >
          <i class="fa-solid fa-paperclip"></i>
        </button>

        <!-- Textarea ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° -->
        <textarea
          id="userInput"
          placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."
          rows="1"
          oninput="autoResize(this)"
        ></textarea>

        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° -->
        <button
          class="icon-btn"
          onclick="sendMessage()"
          id="sendBtn"
          title="‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°"
        >
          <i class="fa-solid fa-paper-plane"></i>
        </button>
      </div>
    </div>

    <script>
      const API_URL = "/calculate";
      let currentImageBase64 = null; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏π‡∏õ Base64

      const chatContainer = document.getElementById("chat-container");
      const userInput = document.getElementById("userInput");
      const sendBtn = document.getElementById("sendBtn");

      function autoResize(textarea) {
        textarea.style.height = "auto";
        textarea.style.height = textarea.scrollHeight + "px";
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
      function handleImageSelect() {
        const fileInput = document.getElementById("imageInput");
        const file = fileInput.files[0];
        if (file) {
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á‡πÜ
          if (!file.type.startsWith("image/")) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
            return;
          }

          const reader = new FileReader();
          reader.onload = function (e) {
            currentImageBase64 = e.target.result;
            document.getElementById("preview-img").src = currentImageBase64;
            document.getElementById("preview-container").style.display =
              "block";
          };
          reader.readAsDataURL(file);
        }
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      function clearImage() {
        document.getElementById("imageInput").value = "";
        currentImageBase64 = null;
        document.getElementById("preview-container").style.display = "none";
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ä‡∏ó
      function appendMessage(role, text, imageSrc = null) {
        const msgDiv = document.createElement("div");
        msgDiv.className = `message ${role}`;

        const avatar = document.createElement("div");
        avatar.className = `avatar ${role}-avatar`;
        avatar.innerText = role === "user" ? "You" : "AI";

        const content = document.createElement("div");
        content.className = "content";

        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏π‡∏õ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô
        let imageHTML = "";
        if (imageSrc) {
          imageHTML = `<img src="${imageSrc}" class="chat-img" alt="Image">`;
        }

        // ‡πÅ‡∏õ‡∏•‡∏á Markdown ‡πÄ‡∏õ‡πá‡∏ô HTML (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Bot) ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏£‡∏á‡πÜ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö User)
        const textHTML =
          role === "bot" ? marked.parse(text) : text.replace(/\n/g, "<br>");

        content.innerHTML = imageHTML + textHTML;

        msgDiv.appendChild(avatar);
        msgDiv.appendChild(content);
        chatContainer.appendChild(msgDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
      async function sendMessage() {
        const text = userInput.value.trim();

        // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á
        if (!text && !currentImageBase64) return;

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á User
        appendMessage("user", text || "(‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û)", currentImageBase64);

        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡∏™‡πà‡∏á
        const promptToSend = text;
        const imageToSend = currentImageBase64;

        // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå Input
        userInput.value = "";
        userInput.style.height = "24px";
        clearImage();
        sendBtn.disabled = true;

        // ‡πÅ‡∏™‡∏î‡∏á Loading
        const loadingDiv = document.createElement("div");
        loadingDiv.className = "message bot loading-msg";
        loadingDiv.innerHTML = `<div class="avatar bot-avatar">AI</div><div class="content"><span class="loading-dots">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î</span></div>`;
        chatContainer.appendChild(loadingDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        try {
          // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Backend
          const response = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              prompt: promptToSend,
              image: imageToSend, // ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ Base64 ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            }),
          });

          const data = await response.json();

          // ‡∏•‡∏ö Loading
          chatContainer.removeChild(loadingDiv);

          // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
          if (data.result) {
            appendMessage("bot", data.result);
          } else {
            appendMessage("bot", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö");
          }
        } catch (error) {
          chatContainer.removeChild(loadingDiv);
          appendMessage(
            "bot",
            "‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ Server ‡∏ï‡∏∑‡πà‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 1 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö)"
          );
        } finally {
          sendBtn.disabled = false;
        }
      }

      // ‡∏Å‡∏î Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
      userInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    </script>
  </body>
</html>
